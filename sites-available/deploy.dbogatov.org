server {
    server_name deploy.dbogatov.org;

    include /etc/nginx/snippets/http_redirect.conf;
}
    
server {
    server_name deploy.dbogatov.org;

    access_log /var/log/nginx/deploy.dbogatov.org.out.log main_ext;
    error_log /var/log/nginx/deploy.dbogatov.org.err.log warn;

    ssl_certificate /etc/letsencrypt/live/dbogatov.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dbogatov.org/privkey.pem;

    include /etc/nginx/snippets/ssl_config.conf;
    
    include /etc/nginx/snippets/letsencrypt.conf;
    
    location /deploy {

        client_max_body_size 50k;
        client_body_buffer_size 50k;

        content_by_lua_block {
            ngx.req.read_body()  -- explicitly read the req body
            local args, err = ngx.req.get_post_args()
            local data = ngx.req.get_body_data()

            local token = ""
            local project = ""
            local path = ""
	    local logfile = "/var/log/deploy"
            
            if data then
             for key, val in pairs(args) do
              if key == "token" then
               token = val
              elseif key == "project" then
               project = val
              end
             end
             ngx.say("Request deployement for project: ", project)

             if token == "SomeSecret" then

              if project == "CV-Website" then
               path = "/srv/www/html/CV-Website/.deploy.sh"
              elseif project == "DashaWebsite" then
               path = "/srv/www/html/DashaWebsite/.deploy.sh"
              elseif project == "MyBlog" then
               path = "/srv/www/html/My-Blog/.deploy.sh"
              elseif project == "Inara-CV" then
               path = "/srv/www/html/Inara-CV/.deploy.sh"
              end

              if project == "" then
               ngx.say("No such project (", project, ")")
              else

	       path = path .. " 1>> " .. logfile .. "/" .. project:lower() .. ".log" .. " 2>> " .. logfile .. "/" .. project:lower() .. ".log"

               ngx.say("Executing ", path)

               os.execute(path)
               
	       ngx.say("Execution completed")
              end

             else
              ngx.say("Invalid token")
             end
            end

        }
    
    }
}
